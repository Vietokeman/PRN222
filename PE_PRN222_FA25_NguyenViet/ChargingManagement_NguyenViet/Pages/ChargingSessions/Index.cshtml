@page
@model ChargingManagement_NguyenViet.Pages.ChargingSessions.IndexModel

@{
    ViewData["Title"] = "Index";
}

<h1>Index</h1>

@if (User.IsInRole("1") || User.IsInRole("2"))
{
    <p>
        <a asp-page="Create">Create New</a>
    </p>
}

<form method="get" class="form-inline mb-3">
    <div class="form-group mr-2">
        <label for="SearchStationName" class="mr-2">Station Name:</label>
        <input type="text" name="SearchStationName" value="@Model.SearchStationName" class="form-control" placeholder="e.g., Station Alpha" />
    </div>
    <div class="form-group mr-2">
        <label for="SearchMinCost" class="mr-2">Min Cost:</label>
        <input type="number" step="0.01" name="SearchMinCost" value="@Model.SearchMinCost" class="form-control" placeholder="10000" />
    </div>
    <div class="form-group mr-2">
        <label for="SearchMaxCost" class="mr-2">Max Cost:</label>
        <input type="number" step="0.01" name="SearchMaxCost" value="@Model.SearchMaxCost" class="form-control" placeholder="150000" />
    </div>
    <div class="form-group mr-2">
        <label for="SearchStartTimeFrom" class="mr-2">Start From:</label>
        <input type="date" name="SearchStartTimeFrom" value="@Model.SearchStartTimeFrom?.ToString("yyyy-MM-dd")" class="form-control" />
    </div>
    <div class="form-group mr-2">
        <label for="SearchStartTimeTo" class="mr-2">To:</label>
        <input type="date" name="SearchStartTimeTo" value="@Model.SearchStartTimeTo?.ToString("yyyy-MM-dd")" class="form-control" />
    </div>
    <button type="submit" class="btn btn-primary">Search</button>
    <a asp-page="./Index" class="btn btn-secondary ml-2">Clear</a>
</form>

@if (Model.HasSearchResults && Model.GroupedSessions != null && Model.GroupedSessions.Any())
{
    @* Search mode: Display grouped results *@
    @foreach (var group in Model.GroupedSessions)
    {
        <h4 class="mt-3">Station: @group.Key</h4>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Session ID</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>KWh Consumed</th>
                    <th>Cost</th>
                    <th>Driver</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="table">
                @foreach (var item in group)
                {
                    <tr data-id="@item.SessionId">
                        <td>@Html.DisplayFor(modelItem => item.SessionId)</td>
                        <td>@Html.DisplayFor(modelItem => item.StartTime)</td>
                        <td>@Html.DisplayFor(modelItem => item.EndTime)</td>
                        <td>@Html.DisplayFor(modelItem => item.KwhConsumed)</td>
                        <td>@Html.DisplayFor(modelItem => item.Cost)</td>
                        <td>@Html.DisplayFor(modelItem => item.Driver.Username)</td>
                        <td>
                            @if (User.IsInRole("1") || User.IsInRole("2"))
                            {
                                <a asp-page="./Edit" asp-route-id="@item.SessionId">Edit</a>
                                <text> | </text>
                            }
                            <a asp-page="./Details" asp-route-id="@item.SessionId">Details</a>
                            @if (User.IsInRole("1") || User.IsInRole("2"))
                            {
                                <text> | </text>
                                <a asp-page="./Delete" asp-route-id="@item.SessionId">Delete</a>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    
    <div class="card mt-3">
        <div class="card-header bg-primary text-white">
            <h4>Aggregate Report</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h5>Total Revenue:</h5>
                    <p class="h3 text-success">@Model.TotalRevenue.ToString("N2") VND</p>
                </div>
                <div class="col-md-6">
                    <h5>Average KWh Consumed:</h5>
                    <p class="h3 text-info">@Model.AverageKwhConsumed.ToString("N2") KWh</p>
                </div>
            </div>
        </div>
    </div>
}
else
{
    @* Normal mode: Display regular table with pagination *@
    <table class="table">
        <thead>
            <tr>
                <th>Start Time</th>
                <th>End Time</th>
                <th>Kwh Consumed</th>
                <th>Cost</th>
                <th>Driver</th>
                <th>Station</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="table">
    @foreach (var item in Model.ChargingSession) {
            <tr data-id="@item.SessionId">
                <td>
                    @Html.DisplayFor(modelItem => item.StartTime)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.EndTime)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.KwhConsumed)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Cost)
                </td>
                <td>
                   @Html.DisplayFor(modelItem => item.Driver.Username)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Station.StationName)
                </td>
                <td>
                    @if (User.IsInRole("1") || User.IsInRole("2"))
                    {
                        <a asp-page="./Edit" asp-route-id="@item.SessionId">Edit</a>
                        <text> | </text>
                    }
                    <a asp-page="./Details" asp-route-id="@item.SessionId">Details</a>
                    @if (User.IsInRole("1") || User.IsInRole("2"))
                    {
                        <text> | </text>
                        <a asp-page="./Delete" asp-route-id="@item.SessionId">Delete</a>
                    }
                </td>
            </tr>
    }
        </tbody>
    </table>

    <nav>
        <ul class="pagination">
            @for (int i = 1; i <= Model.TotalPages; i++)
            {
                <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                    <a class="page-link"
                       asp-page="./Index"
                       asp-route-pageIndex="@i"
                       asp-route-SearchStationName="@Model.SearchStationName"
                       asp-route-SearchMinCost="@Model.SearchMinCost"
                       asp-route-SearchMaxCost="@Model.SearchMaxCost"
                       asp-route-SearchStartTimeFrom="@Model.SearchStartTimeFrom"
                       asp-route-SearchStartTimeTo="@Model.SearchStartTimeTo">
                        @i
                    </a>
                </li>
            }
        </ul>
    </nav>
}

@section Scripts {
    <script src="~/js/signalr/dist/browser/signalr.min.js"></script>
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/notificationHub")
            .build();

        connection.on("ReceiveDelete", function (id) {
            const row = document.querySelector(`tr[data-id="${id}"]`);
            if (row) {
                row.remove();
                const table = document.getElementById('table');
                if (table.children.length === 0) {
                    window.location.reload();
                }
            }
        });

        connection.start().catch(function (err) {
            return console.error(err.toString());
        });
    </script>
}