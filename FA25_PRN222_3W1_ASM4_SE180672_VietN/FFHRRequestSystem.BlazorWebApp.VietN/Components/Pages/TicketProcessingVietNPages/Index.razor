@page "/ticketprocessingvietns"
@rendermode InteractiveServer
@using FFHRRequestSystem.Entitites.VietN.Models
@using FFHRRequestSystem.Services.VietN
@using System.Security.Claims
@inject TicketProcessingVietNService _ticketService
@inject NavigationManager _navigationManager
@inject EmailService _emailService
@inject ExcelExportService _excelExportService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JS

<PageTitle>Tickets Management</PageTitle>

<div class="content-header">
    <h1><i class="bi bi-ticket-perforated"></i> Tickets Management</h1>
    <div class="header-actions">
        <button @onclick="ShowExportModal" class="btn-export" style="margin-right: 10px;">
            <i class="bi bi-file-earmark-excel"></i> EXPORT TO EXCEL
        </button>
        <a href="/ticketprocessingvietns/create" class="btn-add-new">
            <i class="bi bi-plus-circle"></i> ADD NEW TICKET
        </a>
    </div>
</div>

<!-- Search Filters -->
<div class="data-table-container" style="margin-bottom: 20px;">
    <div class="table-header">
        <h2>Search Filters</h2>
    </div>
    <div style="padding: 20px;">
        <EditForm Model="@this" FormName="TicketSearchForm" OnValidSubmit="HandleSearch">
            <AntiforgeryToken />
            <div class="form-row">
                <div class="form-group">
                    <label>Processing Action</label>
                    <InputText @bind-Value="ProcessingAction" class="form-control" placeholder="Enter processing action" />
                </div>
                <div class="form-group">
                    <label>Action Description</label>
                    <InputText @bind-Value="ActionDescription" class="form-control" placeholder="Enter action description" />
                </div>
                <div class="form-group">
                    <label>Type Name</label>
                    <InputText @bind-Value="TypeName" class="form-control" placeholder="Enter type name" />
                </div>
            </div>
            <div class="form-actions" style="margin-top: 0; padding-top: 0; border: none;">
                <button type="button" @onclick="ClearSearch" class="btn-secondary">
                    <i class="bi bi-x-circle"></i> Clear
                </button>
                <button type="submit" class="btn-primary">
                    <i class="bi bi-search"></i> Search
                </button>
            </div>
        </EditForm>
    </div>
</div>

<!-- Data Table -->
<div class="data-table-container">
    <div class="table-header">
        <h2>Ticket Processing Records</h2>
    </div>
    @if (isLoading)
    {
        <div style="text-align: center; padding: 40px;">
            <p><em>Loading...</em></p>
        </div>
    }
    else
    {
        <div style="overflow-x: auto;">
            <table id="ticketProcessingTable" class="data-table">
                <thead>
                    <tr>
                        <th>
                            <a @onclick='() => SortBy("ProcessingCode")' @onclick:preventDefault="true" style="cursor: pointer; color: inherit; text-decoration: none; display: flex; align-items: center; justify-content: space-between;">
                                Code
                                @if (SortColumn == "ProcessingCode")
                                {
                                    <i class="bi bi-caret-@(SortDirection == "asc" ? "up" : "down")-fill"></i>
                                }
                                else
                                {
                                    <i class="bi bi-caret-down" style="opacity: 0.3;"></i>
                                }
                            </a>
                        </th>
                        <th>
                            <a @onclick='() => SortBy("TicketReference")' @onclick:preventDefault="true" style="cursor: pointer; color: inherit; text-decoration: none; display: flex; align-items: center; justify-content: space-between;">
                                Ticket Ref
                                @if (SortColumn == "TicketReference")
                                {
                                    <i class="bi bi-caret-@(SortDirection == "asc" ? "up" : "down")-fill"></i>
                                }
                                else
                                {
                                    <i class="bi bi-caret-down" style="opacity: 0.3;"></i>
                                }
                            </a>
                        </th>
                        <th>
                            <a @onclick='() => SortBy("ProcessingAction")' @onclick:preventDefault="true" style="cursor: pointer; color: inherit; text-decoration: none; display: flex; align-items: center; justify-content: space-between;">
                                Action
                                @if (SortColumn == "ProcessingAction")
                                {
                                    <i class="bi bi-caret-@(SortDirection == "asc" ? "up" : "down")-fill"></i>
                                }
                                else
                                {
                                    <i class="bi bi-caret-down" style="opacity: 0.3;"></i>
                                }
                            </a>
                        </th>
                        <th>Description</th>
                        <th>
                            <a @onclick='() => SortBy("PriorityLevel")' @onclick:preventDefault="true" style="cursor: pointer; color: inherit; text-decoration: none; display: flex; align-items: center; justify-content: space-between;">
                                Priority
                                @if (SortColumn == "PriorityLevel")
                                {
                                    <i class="bi bi-caret-@(SortDirection == "asc" ? "up" : "down")-fill"></i>
                                }
                                else
                                {
                                    <i class="bi bi-caret-down" style="opacity: 0.3;"></i>
                                }
                            </a>
                        </th>
                        <th>
                            <a @onclick='() => SortBy("Status")' @onclick:preventDefault="true" style="cursor: pointer; color: inherit; text-decoration: none; display: flex; align-items: center; justify-content: space-between;">
                                Status
                                @if (SortColumn == "Status")
                                {
                                    <i class="bi bi-caret-@(SortDirection == "asc" ? "up" : "down")-fill"></i>
                                }
                                else
                                {
                                    <i class="bi bi-caret-down" style="opacity: 0.3;"></i>
                                }
                            </a>
                        </th>
                        <th>
                            <a @onclick='() => SortBy("OverdueDays")' @onclick:preventDefault="true" style="cursor: pointer; color: inherit; text-decoration: none; display: flex; align-items: center; justify-content: space-between;">
                                Overdue
                                @if (SortColumn == "OverdueDays")
                                {
                                    <i class="bi bi-caret-@(SortDirection == "asc" ? "up" : "down")-fill"></i>
                                }
                                else
                                {
                                    <i class="bi bi-caret-down" style="opacity: 0.3;"></i>
                                }
                            </a>
                        </th>
                        <th>
                            <a @onclick='() => SortBy("EscalationLevel")' @onclick:preventDefault="true" style="cursor: pointer; color: inherit; text-decoration: none; display: flex; align-items: center; justify-content: space-between;">
                                Escalation
                                @if (SortColumn == "EscalationLevel")
                                {
                                    <i class="bi bi-caret-@(SortDirection == "asc" ? "up" : "down")-fill"></i>
                                }
                                else
                                {
                                    <i class="bi bi-caret-down" style="opacity: 0.3;"></i>
                                }
                            </a>
                        </th>
                        <th>
                            <a @onclick='() => SortBy("IsAutoProcessed")' @onclick:preventDefault="true" style="cursor: pointer; color: inherit; text-decoration: none; display: flex; align-items: center; justify-content: space-between;">
                                Auto
                                @if (SortColumn == "IsAutoProcessed")
                                {
                                    <i class="bi bi-caret-@(SortDirection == "asc" ? "up" : "down")-fill"></i>
                                }
                                else
                                {
                                    <i class="bi bi-caret-down" style="opacity: 0.3;"></i>
                                }
                            </a>
                        </th>
                        <th>
                            <a @onclick='() => SortBy("ProcessedBy")' @onclick:preventDefault="true" style="cursor: pointer; color: inherit; text-decoration: none; display: flex; align-items: center; justify-content: space-between;">
                                Processed By
                                @if (SortColumn == "ProcessedBy")
                                {
                                    <i class="bi bi-caret-@(SortDirection == "asc" ? "up" : "down")-fill"></i>
                                }
                                else
                                {
                                    <i class="bi bi-caret-down" style="opacity: 0.3;"></i>
                                }
                            </a>
                        </th>
                        <th>Resolved Note</th>
                        <th>
                            <a @onclick='() => SortBy("CreatedDate")' @onclick:preventDefault="true" style="cursor: pointer; color: inherit; text-decoration: none; display: flex; align-items: center; justify-content: space-between;">
                                Created
                                @if (SortColumn == "CreatedDate")
                                {
                                    <i class="bi bi-caret-@(SortDirection == "asc" ? "up" : "down")-fill"></i>
                                }
                                else
                                {
                                    <i class="bi bi-caret-down" style="opacity: 0.3;"></i>
                                }
                            </a>
                        </th>
                        <th>
                            <a @onclick='() => SortBy("ModifiedDate")' @onclick:preventDefault="true" style="cursor: pointer; color: inherit; text-decoration: none; display: flex; align-items: center; justify-content: space-between;">
                                Modified
                                @if (SortColumn == "ModifiedDate")
                                {
                                    <i class="bi bi-caret-@(SortDirection == "asc" ? "up" : "down")-fill"></i>
                                }
                                else
                                {
                                    <i class="bi bi-caret-down" style="opacity: 0.3;"></i>
                                }
                            </a>
                        </th>
                        <th>
                            <a @onclick='() => SortBy("TypeName")' @onclick:preventDefault="true" style="cursor: pointer; color: inherit; text-decoration: none; display: flex; align-items: center; justify-content: space-between;">
                                Type Name
                                @if (SortColumn == "TypeName")
                                {
                                    <i class="bi bi-caret-@(SortDirection == "asc" ? "up" : "down")-fill"></i>
                                }
                                else
                                {
                                    <i class="bi bi-caret-down" style="opacity: 0.3;"></i>
                                }
                            </a>
                        </th>
                        <th style="text-align: center;">Actions</th>
                    </tr>
                </thead>
                    <tbody>
                        @foreach (var item in PagedTickets)
                        {
                            <tr data-id="@item.TicketProcessingVietNid">
                                <td>@item.ProcessingCode</td>
                                <td>@item.TicketReference</td>
                                <td>@item.ProcessingAction</td>
                                <td>
                                    <span title="@item.ActionDescription">
                                        @(item.ActionDescription?.Length > 25 ? item.ActionDescription.Substring(0, 25) + "..." : item.ActionDescription)
                                    </span>
                                </td>
                                <td>
                                    @{
                                        var priorityText = item.PriorityLevel switch { 3 => "High", 2 => "Medium", _ => "Low" };
                                        var priorityClass = item.PriorityLevel switch { 3 => "badge-danger", 2 => "badge-warning", _ => "badge-secondary" };
                                    }
                                    <span class="badge @priorityClass">@priorityText</span>
                                </td>
                                <td>
                                    @{
                                        var statusText = item.Status switch { 1 => "Active", 2 => "Resolved", 3 => "Closed", _ => "Unknown" };
                                        var statusClass = item.Status switch { 1 => "badge-success", 2 => "badge-info", 3 => "badge-secondary", _ => "badge-secondary" };
                                    }
                                    <span class="badge @statusClass">@statusText</span>
                                </td>
                                <td>@item.OverdueDays</td>
                                <td>@item.EscalationLevel</td>
                                <td>
                                    @if (item.IsAutoProcessed)
                                    {
                                        <span class="badge badge-info">Auto</span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-secondary">Manual</span>
                                    }
                                </td>
                                <td>@item.ProcessedBy</td>
                                <td>
                                    <span title="@item.ResolvedNote">
                                        @(item.ResolvedNote?.Length > 20 ? item.ResolvedNote.Substring(0, 20) + "..." : item.ResolvedNote)
                                    </span>
                                </td>
                                <td>@item.CreatedDate?.ToString("yyyy-MM-dd")</td>
                                <td>@item.ModifiedDate?.ToString("yyyy-MM-dd")</td>
                                <td>@item.ProcessingTypeVietN?.TypeName</td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="/ticketprocessingvietns/details?ticketprocessingvietnid=@item.TicketProcessingVietNid" class="btn-action btn-view" title="View">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a href="/ticketprocessingvietns/edit?ticketprocessingvietnid=@item.TicketProcessingVietNid" class="btn-action btn-edit" title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <a href="/ticketprocessingvietns/delete?ticketprocessingvietnid=@item.TicketProcessingVietNid" class="btn-action btn-delete" title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        }
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <style>
            .pagination-link { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: #666; cursor: pointer; }
            .pagination-link:hover:not(.disabled) { background-color: rgba(0, 123, 255, 0.17); }
            .pagination-link.disabled { color: #999; cursor: not-allowed; opacity: 0.5; pointer-events: none; }
            .pagination-link.active { background-color: #007bff !important; color: white !important; border-color: #007bff; }
        </style>
        
        <div class="pagination-container" style="padding: 20px; display: flex; align-items: center; justify-content: space-between;">
            <div class="pagination-info">
                <span style="color: #666;">
                    Showing <strong>@FromEntry</strong> to <strong>@ToEntry</strong> of <strong>@TotalItems</strong> entries
                </span>
            </div>

            <div style="display: flex; align-items: center; gap: 20px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label style="margin: 0; color: #666;">Show:</label>
                    <select @bind="PageSize" @bind:after="ChangePageSize" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px;">
                        @foreach (var size in PageSizeOptions)
                        {
                            <option value="@size">@size</option>
                        }
                    </select>
                </div>

                <nav>
                    <ul style="list-style: none; margin: 0; padding: 0; display: flex; gap: 5px;">
                        <!-- First Page -->
                        <li>
                            @if (CurrentPage == 1)
                            {
                                <span class="pagination-link disabled"><i class="bi bi-chevron-double-left"></i></span>
                            }
                            else
                            {
                                <a @onclick="() => GoToPage(1)" @onclick:preventDefault="true" class="pagination-link"><i class="bi bi-chevron-double-left"></i></a>
                            }
                        </li>
                        
                        <!-- Previous Page -->
                        <li>
                            @if (CurrentPage == 1)
                            {
                                <span class="pagination-link disabled"><i class="bi bi-chevron-left"></i></span>
                            }
                            else
                            {
                                <a @onclick="() => GoToPage(CurrentPage - 1)" @onclick:preventDefault="true" class="pagination-link"><i class="bi bi-chevron-left"></i></a>
                            }
                        </li>
                        
                        <!-- Page Numbers -->
                        @foreach (var pageNum in GetPageNumbers())
                        {
                            <li>
                                @if (pageNum == CurrentPage)
                                {
                                    <span class="pagination-link active">@pageNum</span>
                                }
                                else
                                {
                                    <a @onclick="() => GoToPage(pageNum)" @onclick:preventDefault="true" class="pagination-link">@pageNum</a>
                                }
                            </li>
                        }
                        
                        <!-- Next Page -->
                        <li>
                            @if (CurrentPage == TotalPages)
                            {
                                <span class="pagination-link disabled"><i class="bi bi-chevron-right"></i></span>
                            }
                            else
                            {
                                <a @onclick="() => GoToPage(CurrentPage + 1)" @onclick:preventDefault="true" class="pagination-link"><i class="bi bi-chevron-right"></i></a>
                            }
                        </li>
                        
                        <!-- Last Page -->
                        <li>
                            @if (CurrentPage == TotalPages)
                            {
                                <span class="pagination-link disabled"><i class="bi bi-chevron-double-right"></i></span>
                            }
                            else
                            {
                                <a @onclick="() => GoToPage(TotalPages)" @onclick:preventDefault="true" class="pagination-link"><i class="bi bi-chevron-double-right"></i></a>
                            }
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    }
</div>

<!-- Export Modal -->
@if (showExportModal)
{
    <div class="modal-overlay" @onclick="CloseExportModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="bi bi-file-earmark-excel"></i>
                </div>
                <h2>Export to Excel</h2>
                <button class="modal-close" @onclick="CloseExportModal">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            
            <div class="modal-body">
                @if (isExporting)
                {
                    <div class="export-progress">
                        <div class="spinner"></div>
                        <p>@exportMessage</p>
                    </div>
                }
                else if (exportSuccess)
                {
                    <div class="export-success">
                        <i class="bi bi-check-circle-fill"></i>
                        <h3>Export Successful!</h3>
                        <p>@exportMessage</p>
                    </div>
                }
                else if (!string.IsNullOrEmpty(exportError))
                {
                    <div class="export-error">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <h3>Export Failed</h3>
                        <p>@exportError</p>
                    </div>
                }
                else
                {
                    <div class="export-info">
                        <div class="info-item">
                            <i class="bi bi-file-earmark-spreadsheet"></i>
                            <div>
                                <strong>Total Records</strong>
                                <p>@AllTickets.Count tickets will be exported</p>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="bi bi-envelope"></i>
                            <div>
                                <strong>Delivery Method</strong>
                                <p>Excel file will be sent to your email</p>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="bi bi-clock"></i>
                            <div>
                                <strong>Processing Time</strong>
                                <p>Usually takes a few seconds</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="export-email-info">
                        <i class="bi bi-info-circle"></i>
                        <p>The Excel file will be sent to: <strong>@currentUserEmail</strong></p>
                    </div>
                }
            </div>
            
            <div class="modal-footer">
                @if (!isExporting && !exportSuccess)
                {
                    <button class="btn-cancel" @onclick="CloseExportModal">Cancel</button>
                    <button class="btn-confirm" @onclick="HandleExport">
                        <i class="bi bi-download"></i> Export & Send Email
                    </button>
                }
                else if (exportSuccess)
                {
                    <button class="btn-confirm" @onclick="CloseExportModal">Close</button>
                }
            </div>
        </div>
    </div>
}

<style>
    .btn-export {
        padding: 12px 24px;
        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn-export:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
    }

    .btn-export i {
        font-size: 18px;
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        animation: fadeIn 0.3s ease;
    }

    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .modal-content {
        background: white;
        border-radius: 16px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease;
    }

    @@keyframes slideUp {
        from {
            transform: translateY(50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-header {
        background: linear-gradient(135deg, #FFD54F 0%, #FFC107 100%);
        padding: 30px;
        position: relative;
        text-align: center;
        color: white;
    }

    .modal-icon {
        width: 80px;
        height: 80px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
        font-size: 40px;
    }

    .modal-header h2 {
        margin: 0;
        font-size: 24px;
        font-weight: 700;
    }

    .modal-close {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .modal-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: rotate(90deg);
    }

    .modal-body {
        padding: 30px;
    }

    .export-info {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .info-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px;
        background: linear-gradient(135deg, #FFF8E1 0%, #FFECB3 100%);
        border-radius: 8px;
        border-left: 4px solid #FFC107;
    }

    .info-item i {
        font-size: 32px;
        color: #FFC107;
    }

    .info-item strong {
        display: block;
        color: #333;
        font-size: 16px;
        margin-bottom: 4px;
    }

    .info-item p {
        margin: 0;
        color: #666;
        font-size: 14px;
    }

    .export-email-info {
        margin-top: 20px;
        padding: 15px;
        background: #e3f2fd;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
        border-left: 4px solid #2196F3;
    }

    .export-email-info i {
        color: #2196F3;
        font-size: 20px;
    }

    .export-email-info p {
        margin: 0;
        color: #666;
        font-size: 14px;
    }

    .export-email-info strong {
        color: #333;
        font-weight: 600;
    }

    .export-progress {
        text-align: center;
        padding: 40px 20px;
    }

    .spinner {
        width: 60px;
        height: 60px;
        border: 6px solid #f3f3f3;
        border-top: 6px solid #FFC107;
        border-radius: 50%;
        margin: 0 auto 20px;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .export-progress p {
        color: #666;
        font-size: 16px;
    }

    .export-success {
        text-align: center;
        padding: 40px 20px;
    }

    .export-success i {
        font-size: 80px;
        color: #4CAF50;
        margin-bottom: 20px;
    }

    .export-success h3 {
        color: #333;
        margin-bottom: 10px;
    }

    .export-success p {
        color: #666;
    }

    .export-error {
        text-align: center;
        padding: 40px 20px;
    }

    .export-error i {
        font-size: 80px;
        color: #f44336;
        margin-bottom: 20px;
    }

    .export-error h3 {
        color: #333;
        margin-bottom: 10px;
    }

    .export-error p {
        color: #666;
    }

    .modal-footer {
        padding: 20px 30px;
        background: #f8f8f8;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        border-top: 1px solid #e0e0e0;
    }

    .btn-cancel {
        padding: 12px 24px;
        background: #f5f5f5;
        color: #666;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-cancel:hover {
        background: #e0e0e0;
    }

    .btn-confirm {
        padding: 12px 24px;
        background: linear-gradient(135deg, #FFD54F 0%, #FFC107 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-confirm:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
    }
</style>

@code {
    private List<TicketProcessingVietN> AllTickets { get; set; } = new();
    private List<TicketProcessingVietN> PagedTickets { get; set; } = new();
    private bool isLoading = true;

    // Export modal
    private bool showExportModal = false;
    private bool isExporting = false;
    private bool exportSuccess = false;
    private string exportMessage = string.Empty;
    private string exportError = string.Empty;
    private string currentUserEmail = string.Empty;
    private string currentUserName = string.Empty;

    // Search parameters
    private string ProcessingAction { get; set; } = string.Empty;
    private string ActionDescription { get; set; } = string.Empty;
    private string TypeName { get; set; } = string.Empty;

    // Pagination
    private int CurrentPage { get; set; } = 1;
    private int PageSize { get; set; } = 10;
    private int TotalItems { get; set; }
    private int TotalPages { get; set; }
    private int FromEntry { get; set; }
    private int ToEntry { get; set; }
    private int[] PageSizeOptions { get; set; } = new[] { 5, 10, 25, 50, 100 };

    // Sorting
    private string SortColumn { get; set; } = "CreatedDate";
    private string SortDirection { get; set; } = "desc";

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("=== Index.razor OnInitializedAsync Started ===");
        
        // Get current user's email
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        if (user.Identity?.IsAuthenticated == true)
        {
            currentUserEmail = user.FindFirst(ClaimTypes.Email)?.Value ?? "";
            currentUserName = user.FindFirst(ClaimTypes.Name)?.Value ?? "";
            Console.WriteLine($"Current user: {currentUserName}, Email: {currentUserEmail}");
        }
        
        await LoadData();
        Console.WriteLine("=== Index.razor OnInitializedAsync Completed ===");
    }

    private async Task LoadData()
    {
        Console.WriteLine("=== LoadData Started ===");
        isLoading = true;
        try
        {
            Console.WriteLine($"ProcessingAction: {ProcessingAction}");
            Console.WriteLine($"ActionDescription: {ActionDescription}");
            Console.WriteLine($"TypeName: {TypeName}");
            
            if (!string.IsNullOrEmpty(ProcessingAction) || !string.IsNullOrEmpty(ActionDescription) || !string.IsNullOrEmpty(TypeName))
            {
                Console.WriteLine("Performing search...");
                AllTickets = await _ticketService.SearchAsync(ProcessingAction, ActionDescription, TypeName);
                Console.WriteLine($"Search returned {AllTickets.Count} tickets");
            }
            else
            {
                Console.WriteLine("Loading all tickets...");
                AllTickets = await _ticketService.GetAllAsync();
                Console.WriteLine($"Loaded {AllTickets.Count} tickets");
            }

            Console.WriteLine("Applying sorting...");
            ApplySorting();
            
            Console.WriteLine("Applying pagination...");
            ApplyPagination();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ERROR in LoadData: {ex.Message}");
            Console.WriteLine($"Stack Trace: {ex.StackTrace}");
            if (ex.InnerException != null)
            {
                Console.WriteLine($"Inner Exception: {ex.InnerException.Message}");
            }
        }
        finally
        {
            isLoading = false;
            Console.WriteLine($"Loading complete. isLoading = {isLoading}");
        }
        Console.WriteLine("=== LoadData Completed ===");
    }

    private void ApplySorting()
    {
        var query = AllTickets.AsQueryable();
        var isAscending = SortDirection?.ToLower() == "asc";

        query = SortColumn switch
        {
            "ProcessingCode" => isAscending ? query.OrderBy(x => x.ProcessingCode) : query.OrderByDescending(x => x.ProcessingCode),
            "TicketReference" => isAscending ? query.OrderBy(x => x.TicketReference) : query.OrderByDescending(x => x.TicketReference),
            "ProcessingAction" => isAscending ? query.OrderBy(x => x.ProcessingAction) : query.OrderByDescending(x => x.ProcessingAction),
            "PriorityLevel" => isAscending ? query.OrderBy(x => x.PriorityLevel) : query.OrderByDescending(x => x.PriorityLevel),
            "Status" => isAscending ? query.OrderBy(x => x.Status) : query.OrderByDescending(x => x.Status),
            "OverdueDays" => isAscending ? query.OrderBy(x => x.OverdueDays) : query.OrderByDescending(x => x.OverdueDays),
            "EscalationLevel" => isAscending ? query.OrderBy(x => x.EscalationLevel) : query.OrderByDescending(x => x.EscalationLevel),
            "IsAutoProcessed" => isAscending ? query.OrderBy(x => x.IsAutoProcessed) : query.OrderByDescending(x => x.IsAutoProcessed),
            "ProcessedBy" => isAscending ? query.OrderBy(x => x.ProcessedBy) : query.OrderByDescending(x => x.ProcessedBy),
            "CreatedDate" => isAscending ? query.OrderBy(x => x.CreatedDate) : query.OrderByDescending(x => x.CreatedDate),
            "ModifiedDate" => isAscending ? query.OrderBy(x => x.ModifiedDate) : query.OrderByDescending(x => x.ModifiedDate),
            "TypeName" => isAscending ? query.OrderBy(x => x.ProcessingTypeVietN.TypeName) : query.OrderByDescending(x => x.ProcessingTypeVietN.TypeName),
            _ => query.OrderByDescending(x => x.CreatedDate)
        };

        AllTickets = query.ToList();
    }

    private void ApplyPagination()
    {
        TotalItems = AllTickets.Count;
        TotalPages = (int)Math.Ceiling((double)TotalItems / PageSize);

        if (CurrentPage < 1) CurrentPage = 1;
        if (CurrentPage > TotalPages && TotalPages > 0) CurrentPage = TotalPages;

        FromEntry = TotalItems == 0 ? 0 : (CurrentPage - 1) * PageSize + 1;
        ToEntry = Math.Min(CurrentPage * PageSize, TotalItems);

        PagedTickets = AllTickets
            .Skip((CurrentPage - 1) * PageSize)
            .Take(PageSize)
            .ToList();
    }

    private async Task HandleSearch()
    {
        Console.WriteLine("=== HandleSearch Started ===");
        CurrentPage = 1;
        await LoadData();
        Console.WriteLine("=== HandleSearch Completed ===");
    }

    private async Task ClearSearch()
    {
        Console.WriteLine("=== ClearSearch Started ===");
        ProcessingAction = string.Empty;
        ActionDescription = string.Empty;
        TypeName = string.Empty;
        CurrentPage = 1;
        await LoadData();
        Console.WriteLine("=== ClearSearch Completed ===");
    }

    private async Task SortBy(string column)
    {
        Console.WriteLine($"=== SortBy Started: {column} ===");
        if (SortColumn == column)
        {
            SortDirection = SortDirection == "asc" ? "desc" : "asc";
            Console.WriteLine($"Toggled sort direction to: {SortDirection}");
        }
        else
        {
            SortColumn = column;
            SortDirection = "asc";
            Console.WriteLine($"New sort column: {SortColumn}, direction: {SortDirection}");
        }
        ApplySorting();
        ApplyPagination();
        Console.WriteLine("=== SortBy Completed ===");
        await Task.CompletedTask;
    }

    private void GoToPage(int page)
    {
        if (page < 1 || page > TotalPages) return;
        CurrentPage = page;
        ApplyPagination();
    }

    private void ChangePageSize()
    {
        CurrentPage = 1;
        ApplyPagination();
    }

    private List<int> GetPageNumbers()
    {
        var pages = new List<int>();
        var maxPagesToShow = 5;
        var halfRange = maxPagesToShow / 2;

        var startPage = Math.Max(1, CurrentPage - halfRange);
        var endPage = Math.Min(TotalPages, startPage + maxPagesToShow - 1);

        if (endPage - startPage < maxPagesToShow - 1)
        {
            startPage = Math.Max(1, endPage - maxPagesToShow + 1);
        }

        for (int i = startPage; i <= endPage; i++)
        {
            pages.Add(i);
        }

        return pages;
    }

    private void ShowExportModal()
    {
        Console.WriteLine("=== ShowExportModal ===");
        showExportModal = true;
        isExporting = false;
        exportSuccess = false;
        exportError = string.Empty;
        exportMessage = string.Empty;
    }

    private void CloseExportModal()
    {
        Console.WriteLine("=== CloseExportModal ===");
        showExportModal = false;
    }

    private async Task HandleExport()
    {
        Console.WriteLine("=== HandleExport Started ===");
        
        if (string.IsNullOrEmpty(currentUserEmail))
        {
            exportError = "No email address found for current user. Please contact administrator.";
            return;
        }

        isExporting = true;
        exportMessage = "Generating Excel file...";
        StateHasChanged();

        try
        {
            // Step 1: Generate Excel file
            Console.WriteLine($"Exporting {AllTickets.Count} tickets to Excel...");
            var excelData = _excelExportService.ExportTicketsToExcel(AllTickets);
            Console.WriteLine("Excel file generated successfully");

            // Step 2: Send email
            exportMessage = "Sending email...";
            StateHasChanged();

            var fileName = $"TicketProcessing_Export_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";
            var emailBody = _emailService.GenerateExportEmailHtml(currentUserName, AllTickets.Count);
            
            Console.WriteLine($"Sending email to: {currentUserEmail}");
            await _emailService.SendEmailWithAttachmentAsync(
                currentUserEmail,
                "Ticket Processing Export - Excel Report",
                emailBody,
                excelData,
                fileName
            );

            Console.WriteLine("Email sent successfully");

            // Success
            isExporting = false;
            exportSuccess = true;
            exportMessage = $"Excel file has been successfully sent to {currentUserEmail}";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ERROR in HandleExport: {ex.Message}");
            Console.WriteLine($"Stack Trace: {ex.StackTrace}");
            
            isExporting = false;
            exportError = $"Failed to export and send email: {ex.Message}";
            StateHasChanged();
        }

        Console.WriteLine("=== HandleExport Completed ===");
    }
}
