@page "/ticketprocessingvietns"
@rendermode InteractiveServer
@using FFHRRequestSystem.Entitites.VietN.Models
@using FFHRRequestSystem.Services.VietN
@inject TicketProcessingVietNService _ticketService
@inject NavigationManager _navigationManager

<PageTitle>Tickets Management</PageTitle>

<div class="content-header">
    <h1><i class="bi bi-ticket-perforated"></i> Tickets Management</h1>
    <div class="header-actions">
        <a href="/ticketprocessingvietns/create" class="btn-add-new">
            <i class="bi bi-plus-circle"></i> ADD NEW TICKET
        </a>
    </div>
</div>

<!-- Search Filters -->
<div class="data-table-container" style="margin-bottom: 20px;">
    <div class="table-header">
        <h2>Search Filters</h2>
    </div>
    <div style="padding: 20px;">
        <EditForm Model="@this" FormName="TicketSearchForm" OnValidSubmit="HandleSearch">
            <AntiforgeryToken />
            <div class="form-row">
                <div class="form-group">
                    <label>Processing Action</label>
                    <InputText @bind-Value="ProcessingAction" class="form-control" placeholder="Enter processing action" />
                </div>
                <div class="form-group">
                    <label>Action Description</label>
                    <InputText @bind-Value="ActionDescription" class="form-control" placeholder="Enter action description" />
                </div>
                <div class="form-group">
                    <label>Type Name</label>
                    <InputText @bind-Value="TypeName" class="form-control" placeholder="Enter type name" />
                </div>
            </div>
            <div class="form-actions" style="margin-top: 0; padding-top: 0; border: none;">
                <button type="button" @onclick="ClearSearch" class="btn-secondary">
                    <i class="bi bi-x-circle"></i> Clear
                </button>
                <button type="submit" class="btn-primary">
                    <i class="bi bi-search"></i> Search
                </button>
            </div>
        </EditForm>
    </div>
</div>

<!-- Data Table -->
<div class="data-table-container">
    <div class="table-header">
        <h2>Ticket Processing Records</h2>
    </div>
    @if (isLoading)
    {
        <div style="text-align: center; padding: 40px;">
            <p><em>Loading...</em></p>
        </div>
    }
    else
    {
        <div style="overflow-x: auto;">
            <table id="ticketProcessingTable" class="data-table">
                <thead>
                    <tr>
                        <th>
                            <a @onclick='() => SortBy("ProcessingCode")' @onclick:preventDefault="true" style="cursor: pointer; color: inherit; text-decoration: none; display: flex; align-items: center; justify-content: space-between;">
                                Code
                                @if (SortColumn == "ProcessingCode")
                                {
                                    <i class="bi bi-caret-@(SortDirection == "asc" ? "up" : "down")-fill"></i>
                                }
                                else
                                {
                                    <i class="bi bi-caret-down" style="opacity: 0.3;"></i>
                                }
                            </a>
                        </th>
                        <th>
                            <a @onclick='() => SortBy("TicketReference")' @onclick:preventDefault="true" style="cursor: pointer; color: inherit; text-decoration: none; display: flex; align-items: center; justify-content: space-between;">
                                Ticket Ref
                                @if (SortColumn == "TicketReference")
                                {
                                    <i class="bi bi-caret-@(SortDirection == "asc" ? "up" : "down")-fill"></i>
                                }
                                else
                                {
                                    <i class="bi bi-caret-down" style="opacity: 0.3;"></i>
                                }
                            </a>
                        </th>
                        <th>
                            <a @onclick='() => SortBy("ProcessingAction")' @onclick:preventDefault="true" style="cursor: pointer; color: inherit; text-decoration: none; display: flex; align-items: center; justify-content: space-between;">
                                Action
                                @if (SortColumn == "ProcessingAction")
                                {
                                    <i class="bi bi-caret-@(SortDirection == "asc" ? "up" : "down")-fill"></i>
                                }
                                else
                                {
                                    <i class="bi bi-caret-down" style="opacity: 0.3;"></i>
                                }
                            </a>
                        </th>
                        <th>Description</th>
                        <th>
                            <a @onclick='() => SortBy("PriorityLevel")' @onclick:preventDefault="true" style="cursor: pointer; color: inherit; text-decoration: none; display: flex; align-items: center; justify-content: space-between;">
                                Priority
                                @if (SortColumn == "PriorityLevel")
                                {
                                    <i class="bi bi-caret-@(SortDirection == "asc" ? "up" : "down")-fill"></i>
                                }
                                else
                                {
                                    <i class="bi bi-caret-down" style="opacity: 0.3;"></i>
                                }
                            </a>
                        </th>
                        <th>
                            <a @onclick='() => SortBy("Status")' @onclick:preventDefault="true" style="cursor: pointer; color: inherit; text-decoration: none; display: flex; align-items: center; justify-content: space-between;">
                                Status
                                @if (SortColumn == "Status")
                                {
                                    <i class="bi bi-caret-@(SortDirection == "asc" ? "up" : "down")-fill"></i>
                                }
                                else
                                {
                                    <i class="bi bi-caret-down" style="opacity: 0.3;"></i>
                                }
                            </a>
                        </th>
                        <th>
                            <a @onclick='() => SortBy("OverdueDays")' @onclick:preventDefault="true" style="cursor: pointer; color: inherit; text-decoration: none; display: flex; align-items: center; justify-content: space-between;">
                                Overdue
                                @if (SortColumn == "OverdueDays")
                                {
                                    <i class="bi bi-caret-@(SortDirection == "asc" ? "up" : "down")-fill"></i>
                                }
                                else
                                {
                                    <i class="bi bi-caret-down" style="opacity: 0.3;"></i>
                                }
                            </a>
                        </th>
                        <th>
                            <a @onclick='() => SortBy("EscalationLevel")' @onclick:preventDefault="true" style="cursor: pointer; color: inherit; text-decoration: none; display: flex; align-items: center; justify-content: space-between;">
                                Escalation
                                @if (SortColumn == "EscalationLevel")
                                {
                                    <i class="bi bi-caret-@(SortDirection == "asc" ? "up" : "down")-fill"></i>
                                }
                                else
                                {
                                    <i class="bi bi-caret-down" style="opacity: 0.3;"></i>
                                }
                            </a>
                        </th>
                        <th>
                            <a @onclick='() => SortBy("IsAutoProcessed")' @onclick:preventDefault="true" style="cursor: pointer; color: inherit; text-decoration: none; display: flex; align-items: center; justify-content: space-between;">
                                Auto
                                @if (SortColumn == "IsAutoProcessed")
                                {
                                    <i class="bi bi-caret-@(SortDirection == "asc" ? "up" : "down")-fill"></i>
                                }
                                else
                                {
                                    <i class="bi bi-caret-down" style="opacity: 0.3;"></i>
                                }
                            </a>
                        </th>
                        <th>
                            <a @onclick='() => SortBy("ProcessedBy")' @onclick:preventDefault="true" style="cursor: pointer; color: inherit; text-decoration: none; display: flex; align-items: center; justify-content: space-between;">
                                Processed By
                                @if (SortColumn == "ProcessedBy")
                                {
                                    <i class="bi bi-caret-@(SortDirection == "asc" ? "up" : "down")-fill"></i>
                                }
                                else
                                {
                                    <i class="bi bi-caret-down" style="opacity: 0.3;"></i>
                                }
                            </a>
                        </th>
                        <th>Resolved Note</th>
                        <th>
                            <a @onclick='() => SortBy("CreatedDate")' @onclick:preventDefault="true" style="cursor: pointer; color: inherit; text-decoration: none; display: flex; align-items: center; justify-content: space-between;">
                                Created
                                @if (SortColumn == "CreatedDate")
                                {
                                    <i class="bi bi-caret-@(SortDirection == "asc" ? "up" : "down")-fill"></i>
                                }
                                else
                                {
                                    <i class="bi bi-caret-down" style="opacity: 0.3;"></i>
                                }
                            </a>
                        </th>
                        <th>
                            <a @onclick='() => SortBy("ModifiedDate")' @onclick:preventDefault="true" style="cursor: pointer; color: inherit; text-decoration: none; display: flex; align-items: center; justify-content: space-between;">
                                Modified
                                @if (SortColumn == "ModifiedDate")
                                {
                                    <i class="bi bi-caret-@(SortDirection == "asc" ? "up" : "down")-fill"></i>
                                }
                                else
                                {
                                    <i class="bi bi-caret-down" style="opacity: 0.3;"></i>
                                }
                            </a>
                        </th>
                        <th>
                            <a @onclick='() => SortBy("TypeName")' @onclick:preventDefault="true" style="cursor: pointer; color: inherit; text-decoration: none; display: flex; align-items: center; justify-content: space-between;">
                                Type Name
                                @if (SortColumn == "TypeName")
                                {
                                    <i class="bi bi-caret-@(SortDirection == "asc" ? "up" : "down")-fill"></i>
                                }
                                else
                                {
                                    <i class="bi bi-caret-down" style="opacity: 0.3;"></i>
                                }
                            </a>
                        </th>
                        <th style="text-align: center;">Actions</th>
                    </tr>
                </thead>
                    <tbody>
                        @foreach (var item in PagedTickets)
                        {
                            <tr data-id="@item.TicketProcessingVietNid">
                                <td>@item.ProcessingCode</td>
                                <td>@item.TicketReference</td>
                                <td>@item.ProcessingAction</td>
                                <td>
                                    <span title="@item.ActionDescription">
                                        @(item.ActionDescription?.Length > 25 ? item.ActionDescription.Substring(0, 25) + "..." : item.ActionDescription)
                                    </span>
                                </td>
                                <td>
                                    @{
                                        var priorityText = item.PriorityLevel switch { 3 => "High", 2 => "Medium", _ => "Low" };
                                        var priorityClass = item.PriorityLevel switch { 3 => "badge-danger", 2 => "badge-warning", _ => "badge-secondary" };
                                    }
                                    <span class="badge @priorityClass">@priorityText</span>
                                </td>
                                <td>
                                    @{
                                        var statusText = item.Status switch { 1 => "Active", 2 => "Resolved", 3 => "Closed", _ => "Unknown" };
                                        var statusClass = item.Status switch { 1 => "badge-success", 2 => "badge-info", 3 => "badge-secondary", _ => "badge-secondary" };
                                    }
                                    <span class="badge @statusClass">@statusText</span>
                                </td>
                                <td>@item.OverdueDays</td>
                                <td>@item.EscalationLevel</td>
                                <td>
                                    @if (item.IsAutoProcessed)
                                    {
                                        <span class="badge badge-info">Auto</span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-secondary">Manual</span>
                                    }
                                </td>
                                <td>@item.ProcessedBy</td>
                                <td>
                                    <span title="@item.ResolvedNote">
                                        @(item.ResolvedNote?.Length > 20 ? item.ResolvedNote.Substring(0, 20) + "..." : item.ResolvedNote)
                                    </span>
                                </td>
                                <td>@item.CreatedDate?.ToString("yyyy-MM-dd")</td>
                                <td>@item.ModifiedDate?.ToString("yyyy-MM-dd")</td>
                                <td>@item.ProcessingTypeVietN?.TypeName</td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="/ticketprocessingvietns/details?ticketprocessingvietnid=@item.TicketProcessingVietNid" class="btn-action btn-view" title="View">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a href="/ticketprocessingvietns/edit?ticketprocessingvietnid=@item.TicketProcessingVietNid" class="btn-action btn-edit" title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <a href="/ticketprocessingvietns/delete?ticketprocessingvietnid=@item.TicketProcessingVietNid" class="btn-action btn-delete" title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        }
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <style>
            .pagination-link { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: #666; cursor: pointer; }
            .pagination-link:hover:not(.disabled) { background-color: rgba(0, 123, 255, 0.17); }
            .pagination-link.disabled { color: #999; cursor: not-allowed; opacity: 0.5; pointer-events: none; }
            .pagination-link.active { background-color: #007bff !important; color: white !important; border-color: #007bff; }
        </style>
        
        <div class="pagination-container" style="padding: 20px; display: flex; align-items: center; justify-content: space-between;">
            <div class="pagination-info">
                <span style="color: #666;">
                    Showing <strong>@FromEntry</strong> to <strong>@ToEntry</strong> of <strong>@TotalItems</strong> entries
                </span>
            </div>

            <div style="display: flex; align-items: center; gap: 20px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label style="margin: 0; color: #666;">Show:</label>
                    <select @bind="PageSize" @bind:after="ChangePageSize" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px;">
                        @foreach (var size in PageSizeOptions)
                        {
                            <option value="@size">@size</option>
                        }
                    </select>
                </div>

                <nav>
                    <ul style="list-style: none; margin: 0; padding: 0; display: flex; gap: 5px;">
                        <!-- First Page -->
                        <li>
                            @if (CurrentPage == 1)
                            {
                                <span class="pagination-link disabled"><i class="bi bi-chevron-double-left"></i></span>
                            }
                            else
                            {
                                <a @onclick="() => GoToPage(1)" @onclick:preventDefault="true" class="pagination-link"><i class="bi bi-chevron-double-left"></i></a>
                            }
                        </li>
                        
                        <!-- Previous Page -->
                        <li>
                            @if (CurrentPage == 1)
                            {
                                <span class="pagination-link disabled"><i class="bi bi-chevron-left"></i></span>
                            }
                            else
                            {
                                <a @onclick="() => GoToPage(CurrentPage - 1)" @onclick:preventDefault="true" class="pagination-link"><i class="bi bi-chevron-left"></i></a>
                            }
                        </li>
                        
                        <!-- Page Numbers -->
                        @foreach (var pageNum in GetPageNumbers())
                        {
                            <li>
                                @if (pageNum == CurrentPage)
                                {
                                    <span class="pagination-link active">@pageNum</span>
                                }
                                else
                                {
                                    <a @onclick="() => GoToPage(pageNum)" @onclick:preventDefault="true" class="pagination-link">@pageNum</a>
                                }
                            </li>
                        }
                        
                        <!-- Next Page -->
                        <li>
                            @if (CurrentPage == TotalPages)
                            {
                                <span class="pagination-link disabled"><i class="bi bi-chevron-right"></i></span>
                            }
                            else
                            {
                                <a @onclick="() => GoToPage(CurrentPage + 1)" @onclick:preventDefault="true" class="pagination-link"><i class="bi bi-chevron-right"></i></a>
                            }
                        </li>
                        
                        <!-- Last Page -->
                        <li>
                            @if (CurrentPage == TotalPages)
                            {
                                <span class="pagination-link disabled"><i class="bi bi-chevron-double-right"></i></span>
                            }
                            else
                            {
                                <a @onclick="() => GoToPage(TotalPages)" @onclick:preventDefault="true" class="pagination-link"><i class="bi bi-chevron-double-right"></i></a>
                            }
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    }
</div>

@code {
    private List<TicketProcessingVietN> AllTickets { get; set; } = new();
    private List<TicketProcessingVietN> PagedTickets { get; set; } = new();
    private bool isLoading = true;

    // Search parameters
    private string ProcessingAction { get; set; } = string.Empty;
    private string ActionDescription { get; set; } = string.Empty;
    private string TypeName { get; set; } = string.Empty;

    // Pagination
    private int CurrentPage { get; set; } = 1;
    private int PageSize { get; set; } = 10;
    private int TotalItems { get; set; }
    private int TotalPages { get; set; }
    private int FromEntry { get; set; }
    private int ToEntry { get; set; }
    private int[] PageSizeOptions { get; set; } = new[] { 5, 10, 25, 50, 100 };

    // Sorting
    private string SortColumn { get; set; } = "CreatedDate";
    private string SortDirection { get; set; } = "desc";

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("=== Index.razor OnInitializedAsync Started ===");
        await LoadData();
        Console.WriteLine("=== Index.razor OnInitializedAsync Completed ===");
    }

    private async Task LoadData()
    {
        Console.WriteLine("=== LoadData Started ===");
        isLoading = true;
        try
        {
            Console.WriteLine($"ProcessingAction: {ProcessingAction}");
            Console.WriteLine($"ActionDescription: {ActionDescription}");
            Console.WriteLine($"TypeName: {TypeName}");
            
            if (!string.IsNullOrEmpty(ProcessingAction) || !string.IsNullOrEmpty(ActionDescription) || !string.IsNullOrEmpty(TypeName))
            {
                Console.WriteLine("Performing search...");
                AllTickets = await _ticketService.SearchAsync(ProcessingAction, ActionDescription, TypeName);
                Console.WriteLine($"Search returned {AllTickets.Count} tickets");
            }
            else
            {
                Console.WriteLine("Loading all tickets...");
                AllTickets = await _ticketService.GetAllAsync();
                Console.WriteLine($"Loaded {AllTickets.Count} tickets");
            }

            Console.WriteLine("Applying sorting...");
            ApplySorting();
            
            Console.WriteLine("Applying pagination...");
            ApplyPagination();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ERROR in LoadData: {ex.Message}");
            Console.WriteLine($"Stack Trace: {ex.StackTrace}");
            if (ex.InnerException != null)
            {
                Console.WriteLine($"Inner Exception: {ex.InnerException.Message}");
            }
        }
        finally
        {
            isLoading = false;
            Console.WriteLine($"Loading complete. isLoading = {isLoading}");
        }
        Console.WriteLine("=== LoadData Completed ===");
    }

    private void ApplySorting()
    {
        var query = AllTickets.AsQueryable();
        var isAscending = SortDirection?.ToLower() == "asc";

        query = SortColumn switch
        {
            "ProcessingCode" => isAscending ? query.OrderBy(x => x.ProcessingCode) : query.OrderByDescending(x => x.ProcessingCode),
            "TicketReference" => isAscending ? query.OrderBy(x => x.TicketReference) : query.OrderByDescending(x => x.TicketReference),
            "ProcessingAction" => isAscending ? query.OrderBy(x => x.ProcessingAction) : query.OrderByDescending(x => x.ProcessingAction),
            "PriorityLevel" => isAscending ? query.OrderBy(x => x.PriorityLevel) : query.OrderByDescending(x => x.PriorityLevel),
            "Status" => isAscending ? query.OrderBy(x => x.Status) : query.OrderByDescending(x => x.Status),
            "OverdueDays" => isAscending ? query.OrderBy(x => x.OverdueDays) : query.OrderByDescending(x => x.OverdueDays),
            "EscalationLevel" => isAscending ? query.OrderBy(x => x.EscalationLevel) : query.OrderByDescending(x => x.EscalationLevel),
            "IsAutoProcessed" => isAscending ? query.OrderBy(x => x.IsAutoProcessed) : query.OrderByDescending(x => x.IsAutoProcessed),
            "ProcessedBy" => isAscending ? query.OrderBy(x => x.ProcessedBy) : query.OrderByDescending(x => x.ProcessedBy),
            "CreatedDate" => isAscending ? query.OrderBy(x => x.CreatedDate) : query.OrderByDescending(x => x.CreatedDate),
            "ModifiedDate" => isAscending ? query.OrderBy(x => x.ModifiedDate) : query.OrderByDescending(x => x.ModifiedDate),
            "TypeName" => isAscending ? query.OrderBy(x => x.ProcessingTypeVietN.TypeName) : query.OrderByDescending(x => x.ProcessingTypeVietN.TypeName),
            _ => query.OrderByDescending(x => x.CreatedDate)
        };

        AllTickets = query.ToList();
    }

    private void ApplyPagination()
    {
        TotalItems = AllTickets.Count;
        TotalPages = (int)Math.Ceiling((double)TotalItems / PageSize);

        if (CurrentPage < 1) CurrentPage = 1;
        if (CurrentPage > TotalPages && TotalPages > 0) CurrentPage = TotalPages;

        FromEntry = TotalItems == 0 ? 0 : (CurrentPage - 1) * PageSize + 1;
        ToEntry = Math.Min(CurrentPage * PageSize, TotalItems);

        PagedTickets = AllTickets
            .Skip((CurrentPage - 1) * PageSize)
            .Take(PageSize)
            .ToList();
    }

    private async Task HandleSearch()
    {
        Console.WriteLine("=== HandleSearch Started ===");
        CurrentPage = 1;
        await LoadData();
        Console.WriteLine("=== HandleSearch Completed ===");
    }

    private async Task ClearSearch()
    {
        Console.WriteLine("=== ClearSearch Started ===");
        ProcessingAction = string.Empty;
        ActionDescription = string.Empty;
        TypeName = string.Empty;
        CurrentPage = 1;
        await LoadData();
        Console.WriteLine("=== ClearSearch Completed ===");
    }

    private async Task SortBy(string column)
    {
        Console.WriteLine($"=== SortBy Started: {column} ===");
        if (SortColumn == column)
        {
            SortDirection = SortDirection == "asc" ? "desc" : "asc";
            Console.WriteLine($"Toggled sort direction to: {SortDirection}");
        }
        else
        {
            SortColumn = column;
            SortDirection = "asc";
            Console.WriteLine($"New sort column: {SortColumn}, direction: {SortDirection}");
        }
        ApplySorting();
        ApplyPagination();
        Console.WriteLine("=== SortBy Completed ===");
    }

    private async Task GoToPage(int page)
    {
        if (page < 1 || page > TotalPages) return;
        CurrentPage = page;
        ApplyPagination();
    }

    private async Task ChangePageSize()
    {
        CurrentPage = 1;
        ApplyPagination();
    }

    private List<int> GetPageNumbers()
    {
        var pages = new List<int>();
        var maxPagesToShow = 5;
        var halfRange = maxPagesToShow / 2;

        var startPage = Math.Max(1, CurrentPage - halfRange);
        var endPage = Math.Min(TotalPages, startPage + maxPagesToShow - 1);

        if (endPage - startPage < maxPagesToShow - 1)
        {
            startPage = Math.Max(1, endPage - maxPagesToShow + 1);
        }

        for (int i = startPage; i <= endPage; i++)
        {
            pages.Add(i);
        }

        return pages;
    }
}
