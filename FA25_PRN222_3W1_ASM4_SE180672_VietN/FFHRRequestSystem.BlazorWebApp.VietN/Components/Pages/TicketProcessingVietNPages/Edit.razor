@page "/ticketprocessingvietns/edit"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using FFHRRequestSystem.Entitites.VietN.Models
@using FFHRRequestSystem.Services.VietN
@inject TicketProcessingVietNService _ticketService
@inject ProcessingTypeVietNService _typeService
@inject NavigationManager _navigationManager
@inject IToastService _toastService

<PageTitle>Edit Ticket Processing</PageTitle>

@if (TicketProcessingVietN is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="container-fluid py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold text-primary">
                <i class="bi bi-pencil-square me-2"></i>Edit Ticket Processing
            </h2>
            <a href="/ticketprocessingvietns" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to List
            </a>
        </div>

        <div class="row justify-content-center">
            <div class="col-lg-10">
                <EditForm Model="TicketProcessingVietN" OnValidSubmit="HandleUpdate" FormName="EditTicketForm">
                    <AntiforgeryToken />
                    <DataAnnotationsValidator />
                    <ValidationSummary class="text-danger mb-3" />
                    <input type="hidden" @bind="TicketProcessingVietN.TicketProcessingVietNid" />

                    <!-- Basic Information Card -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-info-circle me-2"></i>Basic Information
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Processing Code <span class="text-danger">*</span></label>
                                    <InputText @bind-Value="TicketProcessingVietN.ProcessingCode" class="form-control" />
                                    <ValidationMessage For="() => TicketProcessingVietN.ProcessingCode" class="text-danger" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Ticket Reference <span class="text-danger">*</span></label>
                                    <InputText @bind-Value="TicketProcessingVietN.TicketReference" class="form-control" />
                                    <ValidationMessage For="() => TicketProcessingVietN.TicketReference" class="text-danger" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Processing Type <span class="text-danger">*</span></label>
                                    <InputSelect @bind-Value="TicketProcessingVietN.ProcessingTypeVietNid" class="form-control">
                                        <option value="">-- Select Type --</option>
                                        @foreach (var type in ProcessingTypes)
                                        {
                                            <option value="@type.ProcessingTypeVietNid">@type.TypeName</option>
                                        }
                                    </InputSelect>
                                    <ValidationMessage For="() => TicketProcessingVietN.ProcessingTypeVietNid" class="text-danger" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Related Ticket Code</label>
                                    <InputText @bind-Value="TicketProcessingVietN.RelatedTicketCode" class="form-control" />
                                    <ValidationMessage For="() => TicketProcessingVietN.RelatedTicketCode" class="text-danger" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Processing Details Card -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-gear me-2"></i>Processing Details
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Processing Action <span class="text-danger">*</span></label>
                                    <InputText @bind-Value="TicketProcessingVietN.ProcessingAction" class="form-control" />
                                    <ValidationMessage For="() => TicketProcessingVietN.ProcessingAction" class="text-danger" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Action Description</label>
                                    <InputTextArea @bind-Value="TicketProcessingVietN.ActionDescription" class="form-control" rows="2" />
                                    <ValidationMessage For="() => TicketProcessingVietN.ActionDescription" class="text-danger" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">Priority Level <span class="text-danger">*</span></label>
                                    <InputSelect @bind-Value="TicketProcessingVietN.PriorityLevel" class="form-control">
                                        <option value="1">Low</option>
                                        <option value="2">Medium</option>
                                        <option value="3">High</option>
                                    </InputSelect>
                                    <ValidationMessage For="() => TicketProcessingVietN.PriorityLevel" class="text-danger" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">Status <span class="text-danger">*</span></label>
                                    <InputSelect @bind-Value="TicketProcessingVietN.Status" class="form-control">
                                        <option value="1">Active</option>
                                        <option value="2">Resolved</option>
                                        <option value="3">Closed</option>
                                    </InputSelect>
                                    <ValidationMessage For="() => TicketProcessingVietN.Status" class="text-danger" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">Overdue Days</label>
                                    <InputNumber @bind-Value="TicketProcessingVietN.OverdueDays" class="form-control" />
                                    <ValidationMessage For="() => TicketProcessingVietN.OverdueDays" class="text-danger" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">Escalation Level</label>
                                    <InputNumber @bind-Value="TicketProcessingVietN.EscalationLevel" class="form-control" />
                                    <ValidationMessage For="() => TicketProcessingVietN.EscalationLevel" class="text-danger" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Information Card -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-file-text me-2"></i>Additional Information
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="form-check form-switch">
                                        <InputCheckbox @bind-Value="TicketProcessingVietN.IsAutoProcessed" class="form-check-input" id="isautoprocessed" />
                                        <label class="form-check-label fw-bold" for="isautoprocessed">Is Auto Processed</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Processed By</label>
                                    <InputText @bind-Value="TicketProcessingVietN.ProcessedBy" class="form-control" />
                                    <ValidationMessage For="() => TicketProcessingVietN.ProcessedBy" class="text-danger" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Processed Date</label>
                                    <InputDate @bind-Value="TicketProcessingVietN.ProcessedDate" class="form-control" />
                                    <ValidationMessage For="() => TicketProcessingVietN.ProcessedDate" class="text-danger" />
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-bold">Resolved Note</label>
                                    <InputTextArea @bind-Value="TicketProcessingVietN.ResolvedNote" class="form-control" rows="3" />
                                    <ValidationMessage For="() => TicketProcessingVietN.ResolvedNote" class="text-danger" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <a href="/ticketprocessingvietns" class="btn btn-secondary">
                                    <i class="bi bi-x-circle"></i> Cancel
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save"></i> Save Changes
                                </button>
                            </div>
                        </div>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@code {
    [SupplyParameterFromQuery]
    private Guid TicketProcessingVietNid { get; set; }

    [SupplyParameterFromForm]
    private TicketProcessingVietN? TicketProcessingVietN { get; set; }

    private List<ProcessingTypeVietN> ProcessingTypes { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("=== Edit.razor OnInitializedAsync Started ===");
        Console.WriteLine($"TicketProcessingVietNid: {TicketProcessingVietNid}");
        
        try
        {
            Console.WriteLine("Loading processing types...");
            ProcessingTypes = await _typeService.GetAllAsync();
            Console.WriteLine($"Loaded {ProcessingTypes.Count} processing types");

            if (TicketProcessingVietN == null)
            {
                Console.WriteLine($"Loading ticket with ID: {TicketProcessingVietNid}");
                TicketProcessingVietN = await _ticketService.GetByIdAsync(TicketProcessingVietNid);
            }

            if (TicketProcessingVietN is null)
            {
                Console.WriteLine("ERROR: Ticket not found!");
                _navigationManager.NavigateTo("notfound");
            }
            else
            {
                Console.WriteLine($"Ticket loaded successfully: {TicketProcessingVietN.ProcessingCode}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ERROR in OnInitializedAsync: {ex.Message}");
            Console.WriteLine($"Stack Trace: {ex.StackTrace}");
        }
        Console.WriteLine("=== Edit.razor OnInitializedAsync Completed ===");
    }

    private async Task HandleUpdate()
    {
        Console.WriteLine("=== HandleUpdate Started ===");
        try
        {
            Console.WriteLine($"Updating ticket: {TicketProcessingVietN!.ProcessingCode}");
            Console.WriteLine($"Ticket ID: {TicketProcessingVietN.TicketProcessingVietNid}");
            
            TicketProcessingVietN.ModifiedDate = DateTime.Now;
            Console.WriteLine($"Modified Date set to: {TicketProcessingVietN.ModifiedDate}");
            
            Console.WriteLine("Calling service UpdateAsync...");
            await _ticketService.UpdateAsync(TicketProcessingVietN);
            
            Console.WriteLine("Ticket updated successfully!");
            _toastService.ShowSuccess($"Ticket {TicketProcessingVietN.ProcessingCode} updated successfully!");
            
            Console.WriteLine("Navigating to index page...");
            _navigationManager.NavigateTo("/ticketprocessingvietns");
        }
        catch (DbUpdateConcurrencyException ex)
        {
            Console.WriteLine($"CONCURRENCY ERROR: {ex.Message}");
            if (!await TicketProcessingVietNExists(TicketProcessingVietN!.TicketProcessingVietNid))
            {
                Console.WriteLine("Ticket no longer exists!");
                _toastService.ShowError("Ticket no longer exists in the database.");
                _navigationManager.NavigateTo("notfound");
            }
            else
            {
                Console.WriteLine("Concurrency conflict occurred!");
                _toastService.ShowError("The ticket was modified by another user. Please refresh and try again.");
                throw;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ERROR in HandleUpdate: {ex.Message}");
            Console.WriteLine($"Stack Trace: {ex.StackTrace}");
            if (ex.InnerException != null)
            {
                Console.WriteLine($"Inner Exception: {ex.InnerException.Message}");
            }
            _toastService.ShowError($"Failed to update ticket: {ex.Message}");
        }
        Console.WriteLine("=== HandleUpdate Completed ===");
    }

    private async Task<bool> TicketProcessingVietNExists(Guid id)
    {
        Console.WriteLine($"Checking if ticket exists: {id}");
        var ticket = await _ticketService.GetByIdAsync(id);
        var exists = ticket != null;
        Console.WriteLine($"Ticket exists: {exists}");
        return exists;
    }
}
