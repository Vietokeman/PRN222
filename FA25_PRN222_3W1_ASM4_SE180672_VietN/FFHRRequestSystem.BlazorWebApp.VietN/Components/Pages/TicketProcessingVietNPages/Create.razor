@page "/ticketprocessingvietns/create"
@rendermode InteractiveServer
@using Blazored.Toast.Services
@using FFHRRequestSystem.Entitites.VietN.Models
@using FFHRRequestSystem.Services.VietN
@inject TicketProcessingVietNService _ticketService
@inject ProcessingTypeVietNService _typeService
@inject NavigationManager _navigationManager
@inject IToastService _toastService

<PageTitle>Create Ticket Processing</PageTitle>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-success">
            <i class="bi bi-plus-circle me-2"></i>Create New Ticket Processing
        </h2>
        <a href="/ticketprocessingvietns" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to List
        </a>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <EditForm Model="TicketProcessingVietN" OnValidSubmit="HandleCreate" FormName="CreateTicketForm">
                <AntiforgeryToken />
                <DataAnnotationsValidator />
                <ValidationSummary class="text-danger mb-3" />

                <!-- Basic Information Card -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-info-circle me-2"></i>Basic Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Processing Code <span class="text-danger">*</span></label>
                                <InputText @bind-Value="TicketProcessingVietN.ProcessingCode" class="form-control" placeholder="PROC-2024-0003" />
                                <ValidationMessage For="() => TicketProcessingVietN.ProcessingCode" class="text-danger" />
                                <small class="form-text text-muted">Format: PROC-xxxx-xxxx (e.g., PROC-2024-0003)</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Ticket Reference <span class="text-danger">*</span></label>
                                <InputText @bind-Value="TicketProcessingVietN.TicketReference" class="form-control" />
                                <ValidationMessage For="() => TicketProcessingVietN.TicketReference" class="text-danger" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Processing Type <span class="text-danger">*</span></label>
                                <InputSelect @bind-Value="TicketProcessingVietN.ProcessingTypeVietNid" class="form-control">
                                    <option value="">-- Select Type --</option>
                                    @foreach (var type in ProcessingTypes)
                                    {
                                        <option value="@type.ProcessingTypeVietNid">@type.TypeName</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="() => TicketProcessingVietN.ProcessingTypeVietNid" class="text-danger" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Related Ticket Code</label>
                                <InputText @bind-Value="TicketProcessingVietN.RelatedTicketCode" class="form-control" />
                                <ValidationMessage For="() => TicketProcessingVietN.RelatedTicketCode" class="text-danger" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Processing Details Card -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-gear me-2"></i>Processing Details
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Processing Action <span class="text-danger">*</span></label>
                                <InputText @bind-Value="TicketProcessingVietN.ProcessingAction" class="form-control" />
                                <ValidationMessage For="() => TicketProcessingVietN.ProcessingAction" class="text-danger" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Action Description</label>
                                <InputTextArea @bind-Value="TicketProcessingVietN.ActionDescription" class="form-control" rows="2" />
                                <ValidationMessage For="() => TicketProcessingVietN.ActionDescription" class="text-danger" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Priority Level <span class="text-danger">*</span></label>
                                <InputSelect @bind-Value="TicketProcessingVietN.PriorityLevel" class="form-control">
                                    <option value="1">Low</option>
                                    <option value="2">Medium</option>
                                    <option value="3">High</option>
                                </InputSelect>
                                <ValidationMessage For="() => TicketProcessingVietN.PriorityLevel" class="text-danger" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Status <span class="text-danger">*</span></label>
                                <InputSelect @bind-Value="TicketProcessingVietN.Status" class="form-control">
                                    <option value="1">Active</option>
                                    <option value="2">Resolved</option>
                                    <option value="3">Closed</option>
                                </InputSelect>
                                <ValidationMessage For="() => TicketProcessingVietN.Status" class="text-danger" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Overdue Days</label>
                                <InputNumber @bind-Value="TicketProcessingVietN.OverdueDays" class="form-control" />
                                <ValidationMessage For="() => TicketProcessingVietN.OverdueDays" class="text-danger" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Escalation Level</label>
                                <InputNumber @bind-Value="TicketProcessingVietN.EscalationLevel" class="form-control" />
                                <ValidationMessage For="() => TicketProcessingVietN.EscalationLevel" class="text-danger" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional Information Card -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-file-text me-2"></i>Additional Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    <InputCheckbox @bind-Value="TicketProcessingVietN.IsAutoProcessed" class="form-check-input" id="isautoprocessed" />
                                    <label class="form-check-label fw-bold" for="isautoprocessed">Is Auto Processed</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Processed By</label>
                                <InputText @bind-Value="TicketProcessingVietN.ProcessedBy" class="form-control" />
                                <ValidationMessage For="() => TicketProcessingVietN.ProcessedBy" class="text-danger" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Processed Date</label>
                                <InputDate @bind-Value="TicketProcessingVietN.ProcessedDate" class="form-control" />
                                <ValidationMessage For="() => TicketProcessingVietN.ProcessedDate" class="text-danger" />
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-bold">Resolved Note</label>
                                <InputTextArea @bind-Value="TicketProcessingVietN.ResolvedNote" class="form-control" rows="3" />
                                <ValidationMessage For="() => TicketProcessingVietN.ResolvedNote" class="text-danger" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <a href="/ticketprocessingvietns" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check-circle"></i> Create Ticket
                            </button>
                        </div>
                    </div>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    private TicketProcessingVietN TicketProcessingVietN { get; set; } = new();

    private List<ProcessingTypeVietN> ProcessingTypes { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("=== Create.razor OnInitializedAsync Started ===");
        try
        {
            Console.WriteLine("Loading processing types...");
            ProcessingTypes = await _typeService.GetAllAsync();
            Console.WriteLine($"Loaded {ProcessingTypes.Count} processing types");

            if (TicketProcessingVietN.TicketProcessingVietNid == Guid.Empty)
            {
                Console.WriteLine("Initializing new TicketProcessingVietN");
                TicketProcessingVietN = new TicketProcessingVietN
                {
                    TicketProcessingVietNid = Guid.NewGuid(),
                    PriorityLevel = 1,
                    Status = 1,
                    CreatedDate = DateTime.Now,
                    ModifiedDate = DateTime.Now
                };
                Console.WriteLine($"Created new ticket with ID: {TicketProcessingVietN.TicketProcessingVietNid}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ERROR in OnInitializedAsync: {ex.Message}");
            Console.WriteLine($"Stack Trace: {ex.StackTrace}");
        }
        Console.WriteLine("=== Create.razor OnInitializedAsync Completed ===");
    }

    private async Task HandleCreate()
    {
        Console.WriteLine("=== HandleCreate Started ===");
        try
        {
            Console.WriteLine($"Creating ticket with code: {TicketProcessingVietN.ProcessingCode}");
            Console.WriteLine($"Ticket Reference: {TicketProcessingVietN.TicketReference}");
            Console.WriteLine($"Processing Action: {TicketProcessingVietN.ProcessingAction}");
            Console.WriteLine($"Priority Level: {TicketProcessingVietN.PriorityLevel}");
            Console.WriteLine($"Status: {TicketProcessingVietN.Status}");
            
            TicketProcessingVietN.TicketProcessingVietNid = Guid.NewGuid();
            TicketProcessingVietN.CreatedDate = DateTime.Now;
            TicketProcessingVietN.ModifiedDate = DateTime.Now;

            Console.WriteLine($"Calling service CreateAsync...");
            await _ticketService.CreateAsync(TicketProcessingVietN);
            
            Console.WriteLine("Ticket created successfully!");
            _toastService.ShowSuccess($"Ticket {TicketProcessingVietN.ProcessingCode} created successfully!");
            
            Console.WriteLine("Navigating to index page...");
            _navigationManager.NavigateTo("/ticketprocessingvietns");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ERROR in HandleCreate: {ex.Message}");
            Console.WriteLine($"Stack Trace: {ex.StackTrace}");
            if (ex.InnerException != null)
            {
                Console.WriteLine($"Inner Exception: {ex.InnerException.Message}");
            }
            _toastService.ShowError($"Failed to create ticket: {ex.Message}");
        }
        Console.WriteLine("=== HandleCreate Completed ===");
    }
}
