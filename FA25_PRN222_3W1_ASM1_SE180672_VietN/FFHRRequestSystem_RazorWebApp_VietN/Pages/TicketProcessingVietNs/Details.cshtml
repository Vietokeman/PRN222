@page
@model FFHRRequestSystem_RazorWebApp_VietN.Pages.TicketProcessingVietNs.DetailsModel

@{
    ViewData["Title"] = "Ticket Processing Details";

    string priorityText = Model.TicketProcessingVietN.PriorityLevel switch
    {
        3 => "High",
        2 => "Medium",
        _ => "Low"
    };
    string priorityClass = Model.TicketProcessingVietN.PriorityLevel switch
    {
        3 => "bg-danger",
        2 => "bg-warning text-dark",
        _ => "bg-secondary"
    };

    string statusText = Model.TicketProcessingVietN.Status switch
    {
        1 => "Active",
        2 => "Resolved",
        3 => "Closed",
        _ => "Unknown"
    };
    string statusClass = Model.TicketProcessingVietN.Status switch
    {
        1 => "bg-success",
        2 => "bg-info",
        3 => "bg-secondary",
        _ => "bg-light text-dark"
    };
}

<div id="ticketProcessingDetailId" class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary">
            <i class="bi bi-ticket-detailed me-2"></i>Ticket Processing Details
        </h2>
        <div>
            <a asp-page="./Edit" asp-route-id="@Model.TicketProcessingVietN.TicketProcessingVietNid" class="btn btn-primary me-2">
                <i class="bi bi-pencil"></i> Edit
            </a>
            <a asp-page="./Index" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to List
            </a>
        </div>
    </div>

    @Html.HiddenFor(model => model.TicketProcessingVietN.TicketProcessingVietNid)

    <!-- Basic Information Card -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="bi bi-info-circle me-2"></i>Basic Information
            </h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="border rounded p-3 h-100">
                        <label class="form-label fw-bold text-muted">Processing Code</label>
                        <p class="mb-0 fs-5" id="detail-processingCode">@Model.TicketProcessingVietN.ProcessingCode</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="border rounded p-3 h-100">
                        <label class="form-label fw-bold text-muted">Ticket Reference</label>
                        <p class="mb-0 fs-5" id="detail-ticketReference">@Model.TicketProcessingVietN.TicketReference</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="border rounded p-3 h-100">
                        <label class="form-label fw-bold text-muted">Processing Type</label>
                        <p class="mb-0 fs-5" id="detail-processingType">@Model.TicketProcessingVietN.ProcessingTypeVietN?.TypeName</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Processing Details Card -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">
                <i class="bi bi-gear me-2"></i>Processing Details
            </h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="border rounded p-3 h-100">
                        <label class="form-label fw-bold text-muted">Processing Action</label>
                        <p class="mb-0" id="detail-processingAction">@Model.TicketProcessingVietN.ProcessingAction</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="border rounded p-3 h-100">
                        <label class="form-label fw-bold text-muted">Action Description</label>
                        <p class="mb-0" id="detail-actionDescription">@Model.TicketProcessingVietN.ActionDescription</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="border rounded p-3 h-100">
                        <label class="form-label fw-bold text-muted">Priority Level</label>
                        <p class="mb-0">
                            <span class="badge @priorityClass fs-6" id="detail-priority">@priorityText</span>
                        </p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="border rounded p-3 h-100">
                        <label class="form-label fw-bold text-muted">Status</label>
                        <p class="mb-0">
                            <span class="badge @statusClass fs-6" id="detail-status">@statusText</span>
                        </p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="border rounded p-3 h-100">
                        <label class="form-label fw-bold text-muted">Overdue Days</label>
                        <p class="mb-0" id="detail-overdue">@Model.TicketProcessingVietN.OverdueDays</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="border rounded p-3 h-100">
                        <label class="form-label fw-bold text-muted">Escalation Level</label>
                        <p class="mb-0" id="detail-escalation">@Model.TicketProcessingVietN.EscalationLevel</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="border rounded p-3 h-100">
                        <label class="form-label fw-bold text-muted">Auto Processed</label>
                        <p class="mb-0">
                            @if (Model.TicketProcessingVietN.IsAutoProcessed)
                            {
                                <span class="badge bg-info text-dark" id="detail-auto">Automatic</span>
                            }
                            else
                            {
                                <span class="badge bg-dark" id="detail-auto">Manual</span>
                            }
                        </p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="border rounded p-3 h-100">
                        <label class="form-label fw-bold text-muted">Processed By</label>
                        <p class="mb-0" id="detail-processedBy">@Model.TicketProcessingVietN.ProcessedBy</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dates and Notes Card -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">
                <i class="bi bi-calendar-event me-2"></i>Dates & Notes
            </h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <div class="border rounded p-3 h-100">
                        <label class="form-label fw-bold text-muted">Created Date</label>
                        <p class="mb-0" id="detail-createdDate">@Model.TicketProcessingVietN.CreatedDate?.ToString("dddd, MMMM dd, yyyy")</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="border rounded p-3 h-100">
                        <label class="form-label fw-bold text-muted">Modified Date</label>
                        <p class="mb-0" id="detail-modifiedDate">@Model.TicketProcessingVietN.ModifiedDate?.ToString("dddd, MMMM dd, yyyy")</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="border rounded p-3 h-100">
                        <label class="form-label fw-bold text-muted">Processed Date</label>
                        <p class="mb-0" id="detail-processedDate">@Model.TicketProcessingVietN.ProcessedDate?.ToString("dddd, MMMM dd, yyyy")</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="border rounded p-3 h-100">
                        <label class="form-label fw-bold text-muted">Related Ticket Code</label>
                        <p class="mb-0" id="detail-relatedTicketCode">@Model.TicketProcessingVietN.RelatedTicketCode</p>
                    </div>
                </div>
                <div class="col-12">
                    <div class="border rounded p-3">
                        <label class="form-label fw-bold text-muted">Resolved Note</label>
                        <p class="mb-0" id="detail-resolvedNote">@Model.TicketProcessingVietN.ResolvedNote</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/signalr/dist/browser/signalr.js"></script>
    <script>
        "use strict";

        var connection = new signalR.HubConnectionBuilder().withUrl("/notificationHub").build();

        connection.start().then(function () {
            console.log("Connected to NotificationHub");
        }).catch(function (err) {
            return console.error(err.toString());
        });

        function parsePayload(payload) {
            return typeof payload === 'string' ? JSON.parse(payload) : payload;
        }

        function formatDateText(dateValue) {
            if (!dateValue) return '';
            const date = new Date(dateValue);
            if (Number.isNaN(date.getTime())) return '';
            return date.toLocaleDateString();
        }

        function setBadge(elementId, text, cls) {
            const el = document.getElementById(elementId);
            if (!el) return;
            el.textContent = text;
            el.className = `badge fs-6 ${cls}`.trim();
        }

        function setText(elementId, value) {
            const el = document.getElementById(elementId);
            if (el) el.textContent = value ?? '';
        }

        connection.on("ReceiverUpdate", function (payload) {
            const data = parsePayload(payload);
            const ticketProcessingIdHidden = document.getElementById("TicketProcessingVietN_TicketProcessingVietNid")?.value;
            if (!data || ticketProcessingIdHidden !== data.TicketProcessingVietNid) return;

            setText("detail-processingCode", data.ProcessingCode);
            setText("detail-ticketReference", data.TicketReference);
            setText("detail-processingType", data.TypeName);
            setText("detail-processingAction", data.ProcessingAction);
            setText("detail-actionDescription", data.ActionDescription);
            setText("detail-overdue", data.OverdueDays);
            setText("detail-escalation", data.EscalationLevel);
            setText("detail-processedBy", data.ProcessedBy);
            setText("detail-createdDate", formatDateText(data.CreatedDate));
            setText("detail-modifiedDate", formatDateText(data.ModifiedDate));
            setText("detail-processedDate", formatDateText(data.ProcessedDate));
            setText("detail-relatedTicketCode", data.RelatedTicketCode);
            setText("detail-resolvedNote", data.ResolvedNote);

            const priorityMap = {
                3: { text: 'High', cls: 'bg-danger' },
                2: { text: 'Medium', cls: 'bg-warning text-dark' },
                1: { text: 'Low', cls: 'bg-secondary' }
            };
            const statusMap = {
                1: { text: 'Active', cls: 'bg-success' },
                2: { text: 'Resolved', cls: 'bg-info' },
                3: { text: 'Closed', cls: 'bg-secondary' }
            };

            const priority = priorityMap[data.PriorityLevel] || { text: 'Unknown', cls: 'bg-light text-dark' };
            const status = statusMap[data.Status] || { text: 'Unknown', cls: 'bg-light text-dark' };

            setBadge("detail-priority", priority.text, priority.cls);
            setBadge("detail-status", status.text, status.cls);

            const autoEl = document.getElementById("detail-auto");
            if (autoEl) {
                autoEl.textContent = data.IsAutoProcessed ? "Automatic" : "Manual";
                autoEl.className = data.IsAutoProcessed ? "badge bg-info text-dark" : "badge bg-dark";
            }
        });

        connection.on("ReceiverDelete", function (ticketProcessingVietNid) {
            var ticketProcessingIdHidden = document.getElementById("TicketProcessingVietN_TicketProcessingVietNid")?.value;
            if (ticketProcessingIdHidden == ticketProcessingVietNid) {
                document.getElementById("ticketProcessingDetailId").innerHTML = "<div class='alert alert-danger text-center'><h4>This item has been deleted</h4><a href='/TicketProcessingVietNs/Index' class='btn btn-primary mt-3'>Back to List</a></div>";
            }
        });
    </script>
}
