@page
@model FFHRRequestSystem_RazorWebApp_VietN.Pages.TicketProcessingVietNs.IndexModel
@{
    ViewData["Title"] = "Tickets Management";
    Layout = "~/Pages/Shared/_LayoutCRUD.cshtml";
}

<div class="content-header">
    <h1><i class="bi bi-ticket-perforated"></i> Tickets Management</h1>
    <div class="header-actions">
        <div class="search-box">
            <input type="text" id="quickSearch" placeholder="Search..." />
            <i class="bi bi-search"></i>
        </div>
        <button class="notification-btn">
            <i class="bi bi-bell"></i>
            <span class="notification-badge">3</span>
        </button>
        <a asp-page="./Create" class="btn-add-new">
            <i class="bi bi-plus-circle"></i> ADD NEW TICKET
        </a>
    </div>
</div>

    <!-- Data Table -->
    <div class="data-table-container">
        <div class="table-header">
            <h2>Ticket Processing Records</h2>
        </div>
        <div style="overflow-x: auto;">
            <table id="ticketProcessingTable" class="data-table">
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Ticket Ref</th>
                        <th>Action</th>
                        <th>Description</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th>Overdue</th>
                        <th>Escalation</th>
                        <th>Auto</th>
                        <th>Processed By</th>
                        <th>Resolved Note</th>
                        <th>Created</th>
                        <th>Modified</th>
                        <th>Type Name</th>
                        <th style="text-align: center;">Actions</th>
                    </tr>
                </thead>
                    <tbody>
                        @foreach (var item in Model.PagedTickets)
                        {
                            <tr data-id="@item.TicketProcessingVietNid">
                                <td>@item.ProcessingCode</td>
                                <td>@item.TicketReference</td>
                                <td>@item.ProcessingAction</td>
                                <td>
                                    <span title="@item.ActionDescription">
                                        @(item.ActionDescription?.Length > 25 ? item.ActionDescription.Substring(0, 25) + "..." : item.ActionDescription)
                                    </span>
                                </td>
                                <td>
                                    @{
                                        string priorityText = item.PriorityLevel switch
                                        {
                                            3 => "High",
                                            2 => "Medium",
                                            _ => "Low"
                                        };
                                        string priorityClass = item.PriorityLevel switch
                                        {
                                            3 => "badge-danger",
                                            2 => "badge-warning",
                                            _ => "badge-secondary"
                                        };
                                    }
                                    <span class="badge @priorityClass">@priorityText</span>
                                </td>
                                <td>
                                    @{
                                        string statusText = item.Status switch
                                        {
                                            1 => "Active",
                                            2 => "Resolved",
                                            3 => "Closed",
                                            _ => "Unknown"
                                        };
                                        string statusClass = item.Status switch
                                        {
                                            1 => "badge-success",
                                            2 => "badge-info",
                                            3 => "badge-secondary",
                                            _ => "badge-secondary"
                                        };
                                    }
                                    <span class="badge @statusClass">@statusText</span>
                                </td>
                                <td>@item.OverdueDays</td>
                                <td>@item.EscalationLevel</td>
                                <td>
                                    @if (item.IsAutoProcessed)
                                    {
                                        <span class="badge badge-info">Auto</span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-secondary">Manual</span>
                                    }
                                </td>
                                <td>@item.ProcessedBy</td>
                                <td>
                                    <span title="@item.ResolvedNote">
                                        @(item.ResolvedNote?.Length > 20 ? item.ResolvedNote.Substring(0, 20) + "..." : item.ResolvedNote)
                                    </span>
                                </td>
                                <td>@item.CreatedDate?.ToString("yyyy-MM-dd")</td>
                                <td>@item.ModifiedDate?.ToString("yyyy-MM-dd")</td>
                                <td>@item.ProcessingTypeVietN?.TypeName</td>
                                <td>
                                    <div class="action-buttons">
                                        <a asp-page="./Details" asp-route-id="@item.TicketProcessingVietNid" class="btn-action btn-view" title="View">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a asp-page="./Edit" asp-route-id="@item.TicketProcessingVietNid" class="btn-action btn-edit" title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <a asp-page="./Delete" asp-route-id="@item.TicketProcessingVietNid" class="btn-action btn-delete" title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        }
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <style>
            .pagination-link { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: #666; cursor: pointer; }
            .pagination-link:hover { background-color: rgba(0, 123, 255, 0.17); }
            .pagination-link.disabled { color: #999; cursor: not-allowed; opacity: 0.5; pointer-events: none; }
            .pagination-link.active { background-color: #007bff; color: white; border-color: #007bff; }
        </style>
        
        <div class="pagination-container" style="padding: 20px; display: flex; align-items: center; justify-content: space-between;">
            <div class="pagination-info">
                <span style="color: #666;">
                    Showing <strong>@Model.FromEntry</strong> to <strong>@Model.ToEntry</strong> of <strong>@Model.TotalItems</strong> entries
                </span>
            </div>
            
            <div style="display: flex; align-items: center; gap: 20px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label style="margin: 0; color: #666;">Show:</label>
                    <select id="pageSizeSelect" onchange="changePage(this)" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px;">
                        @foreach (var size in Model.PageSizeOptions)
                        {
                            <option value="@size" selected="@(size == Model.PageSize)">@size</option>
                        }
                    </select>
                </div>
                
                <nav>
                    <ul style="list-style: none; margin: 0; padding: 0; display: flex; gap: 5px;">
                        <!-- First Page -->
                        <li>
                            @if (Model.CurrentPage == 1)
                            {
                                <span class="pagination-link disabled"><i class="bi bi-chevron-double-left"></i></span>
                            }
                            else
                            {
                                <a asp-page="./Index" asp-route-currentpage="1" asp-route-pagesize="@Model.PageSize" asp-route-processingAction="@Model.ProcessingAction" asp-route-actionDescription="@Model.ActionDescription" asp-route-typeName="@Model.TypeName" 
                                   class="pagination-link"><i class="bi bi-chevron-double-left"></i></a>
                            }
                        </li>
                        
                        <!-- Previous Page -->
                        <li>
                            @if (Model.CurrentPage == 1)
                            {
                                <span class="pagination-link disabled"><i class="bi bi-chevron-left"></i></span>
                            }
                            else
                            {
                                <a asp-page="./Index" asp-route-currentpage="@(Model.CurrentPage - 1)" asp-route-pagesize="@Model.PageSize" asp-route-processingAction="@Model.ProcessingAction" asp-route-actionDescription="@Model.ActionDescription" asp-route-typeName="@Model.TypeName" 
                                   class="pagination-link"><i class="bi bi-chevron-left"></i></a>
                            }
                        </li>
                        
                        <!-- Page Numbers -->
                        @foreach (var pageNum in Model.GetPageNumbers())
                        {
                            <li>
                                @if (pageNum == Model.CurrentPage)
                                {
                                    <span class="pagination-link active">@pageNum</span>
                                }
                                else
                                {
                                    <a asp-page="./Index" asp-route-currentpage="@pageNum" asp-route-pagesize="@Model.PageSize" asp-route-processingAction="@Model.ProcessingAction" asp-route-actionDescription="@Model.ActionDescription" asp-route-typeName="@Model.TypeName" 
                                       class="pagination-link">@pageNum</a>
                                }
                            </li>
                        }
                        
                        <!-- Next Page -->
                        <li>
                            @if (Model.CurrentPage == Model.TotalPages)
                            {
                                <span class="pagination-link disabled"><i class="bi bi-chevron-right"></i></span>
                            }
                            else
                            {
                                <a asp-page="./Index" asp-route-currentpage="@(Model.CurrentPage + 1)" asp-route-pagesize="@Model.PageSize" asp-route-processingAction="@Model.ProcessingAction" asp-route-actionDescription="@Model.ActionDescription" asp-route-typeName="@Model.TypeName" 
                                   class="pagination-link"><i class="bi bi-chevron-right"></i></a>
                            }
                        </li>
                        
                        <!-- Last Page -->
                        <li>
                            @if (Model.CurrentPage == Model.TotalPages)
                            {
                                <span class="pagination-link disabled"><i class="bi bi-chevron-double-right"></i></span>
                            }
                            else
                            {
                                <a asp-page="./Index" asp-route-currentpage="@Model.TotalPages" asp-route-pagesize="@Model.PageSize" asp-route-processingAction="@Model.ProcessingAction" asp-route-actionDescription="@Model.ActionDescription" asp-route-typeName="@Model.TypeName" 
                                   class="pagination-link"><i class="bi bi-chevron-double-right"></i></a>
                            }
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<script>
function changePage(select) {
    var pageSize = select.value;
    var currentUrl = window.location.href;
    var newUrl = new URL(currentUrl);
    newUrl.searchParams.set('pageSize', pageSize);
    newUrl.searchParams.set('currentPage', '1');
    window.location.href = newUrl.toString();
}
</script>

@section Scripts {
    <script src="~/lib/jquery/jquery.min.js"></script>
    <script src="~/js/signalr/dist/browser/signalr.js"></script>
    <script>
        // Toast notification helper
        function showToast(message, type = 'success') {
            const bgColors = {
                success: 'linear-gradient(to right, #00b09b, #96c93d)',
                error: 'linear-gradient(to right, #ff5f6d, #ffc371)',
                info: 'linear-gradient(to right, #4facfe, #00f2fe)',
                warning: 'linear-gradient(to right, #f093fb, #f5576c)'
            };

            Toastify({
                text: message,
                duration: 3000,
                gravity: "top",
                position: "right",
                style: {
                    background: bgColors[type] || bgColors.success,
                },
                stopOnFocus: true,
            }).showToast();
        }

        function truncate(text, length) {
            if (!text) return '';
            return text.length > length ? text.substring(0, length) + '...' : text;
        }

        function formatDate(dateValue) {
            if (!dateValue) return '';
            const date = new Date(dateValue);
            if (Number.isNaN(date.getTime())) return '';
            return date.toISOString().split('T')[0];
        }

        function renderRow(data) {
            const priority = {
                3: { text: 'High', cls: 'badge-danger' },
                2: { text: 'Medium', cls: 'badge-warning' },
                1: { text: 'Low', cls: 'badge-secondary' }
            }[data.PriorityLevel] || { text: 'Unknown', cls: 'badge-secondary' };

            const status = {
                1: { text: 'Active', cls: 'badge-success' },
                2: { text: 'Resolved', cls: 'badge-info' },
                3: { text: 'Closed', cls: 'badge-secondary' }
            }[data.Status] || { text: 'Unknown', cls: 'badge-secondary' };

            const autoBadge = data.IsAutoProcessed
                ? '<span class="badge badge-info">Auto</span>'
                : '<span class="badge badge-secondary">Manual</span>';

            return `
                <tr data-id="${data.TicketProcessingVietNid}">
                    <td>${data.ProcessingCode || ''}</td>
                    <td>${data.TicketReference || ''}</td>
                    <td>${data.ProcessingAction || ''}</td>
                    <td><span title="${data.ActionDescription || ''}">${truncate(data.ActionDescription, 25)}</span></td>
                    <td><span class="badge ${priority.cls}">${priority.text}</span></td>
                    <td><span class="badge ${status.cls}">${status.text}</span></td>
                    <td>${data.OverdueDays ?? ''}</td>
                    <td>${data.EscalationLevel ?? ''}</td>
                    <td>${autoBadge}</td>
                    <td>${data.ProcessedBy || ''}</td>
                    <td><span title="${data.ResolvedNote || ''}">${truncate(data.ResolvedNote, 25)}</span></td>
                    <td>${formatDate(data.CreatedDate)}</td>
                    <td>${formatDate(data.ModifiedDate)}</td>
                    <td>${data.ProcessingTypeVietN?.TypeName || data.TypeName || ''}</td>
                    <td>
                        <div class="action-buttons">
                            <a href="/TicketProcessingVietNs/Details?id=${data.TicketProcessingVietNid}" class="btn-action btn-view" title="View">
                                <i class="bi bi-eye"></i>
                            </a>
                            <a href="/TicketProcessingVietNs/Edit?id=${data.TicketProcessingVietNid}" class="btn-action btn-edit" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <a href="/TicketProcessingVietNs/Delete?id=${data.TicketProcessingVietNid}" class="btn-action btn-delete" title="Delete">
                                <i class="bi bi-trash"></i>
                            </a>
                        </div>
                    </td>
                </tr>`;
        }

        "use strict";

        var connection = new signalR.HubConnectionBuilder().withUrl("/notificationHub").build();

        connection.start().then(function () {
            console.log("[SignalR] Connected to NotificationHub");
            console.log("[SignalR] Connection ID:", connection.connectionId);
        }).catch(function (err) {
            console.error("[SignalR] Connection failed:", err.toString());
            return console.error(err.toString());
        });

        function parsePayload(payload) {
            return typeof payload === 'string' ? JSON.parse(payload) : payload;
        }

        connection.on("ReceiverCreate", function (payload) {
            console.log("[SignalR] ReceiverCreate triggered!");
            const data = parsePayload(payload);
            if (!data) {
                console.error("[SignalR] Failed to parse data");
                return;
            }
            const newRow = renderRow(data);
            $('#ticketProcessingTable tbody').prepend(newRow);
            showToast(`Ticket "${data.ProcessingCode}" created successfully via SignalR!`, "success");
        });

        connection.on("ReceiverUpdate", function (payload) {
            console.log("[SignalR] ReceiverUpdate triggered!");
            const data = parsePayload(payload);
            if (!data) {
                console.error("[SignalR] Failed to parse data");
                return;
            }
            const row = $('#ticketProcessingTable tbody').find(`tr[data-id='${data.TicketProcessingVietNid}']`);
            if (row.length > 0) {
                row.replaceWith(renderRow(data));
                showToast(`Ticket "${data.ProcessingCode}" updated successfully via SignalR!`, "info");
            }
        });

        connection.on("ReceiverDelete", function (ticketProcessingVietNid) {
            console.log("[SignalR] ReceiverDelete triggered!");
            const row = $('#ticketProcessingTable tbody').find(`tr[data-id='${ticketProcessingVietNid}']`);
            if (row.length > 0) {
                row.remove();
                showToast("Ticket deleted successfully via SignalR!", "warning");
            }
        });
    </script>

        // Show TempData messages
        $(document).ready(function() {
            @if (TempData["SuccessMessage"] != null)
            {
                <text>
                showToast('@TempData["SuccessMessage"]', 'success');
                </text>
            }
            @if (TempData["ErrorMessage"] != null)
            {
                <text>
                showToast('@TempData["ErrorMessage"]', 'error');
                </text>
            }
            @if (TempData["InfoMessage"] != null)
            {
                <text>
                showToast('@TempData["InfoMessage"]', 'info');
                </text>
            }
        });
    </script>
}